Subquery FIRST:

SELECT title
FROM film
WHERE film_id IN (
    SELECT film_id
    FROM inventory i
    JOIN rental r ON i.inventory_id = r.inventory_id
    JOIN payment p ON r.rental_id = p.rental_id
    WHERE customer_id IN (
        SELECT customer_id
        FROM payment
        GROUP BY customer_id
        HAVING SUM(amount) > 100
    )
);



CTE (Filtering Results):

WITH high_spenders AS (
    SELECT customer_id
    FROM payment
    GROUP BY customer_id
    HAVING SUM(amount) > 100
),
films_rented AS (
    SELECT film_id
    FROM inventory i
    JOIN rental r ON i.inventory_id = r.inventory_id
    JOIN payment p ON r.rental_id = p.rental_id
    WHERE p.customer_id IN (SELECT customer_id FROM high_spenders)
)
SELECT title
FROM film
WHERE film_id IN (SELECT film_id FROM films_rented);



